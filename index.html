<!DOCTYPE html>
<html lang="de">
<head>
  <link rel="icon" type="image/png" href="favicon.png">
  <meta charset="UTF-8" />
  <title>OllamaDesk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  
  <!-- Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
    :root {
      /* Light Theme (Soft & Clean) */
      --bg-app: #f8f9fa;
      --bg-panel: rgba(255, 255, 255, 0.7);
      --fg: #1e293b;
      --fg-muted: #64748b;
      --border: rgba(226, 232, 240, 0.8);
      
      --primary: #6366f1; /* Indigo */
      --primary-hover: #4f46e5;
      --primary-fg: #ffffff;
      
      --msg-user-bg: #6366f1;
      --msg-user-fg: #ffffff;
      --msg-ai-bg: #ffffff;
      --msg-ai-fg: #334155;
      
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
      --glass-blur: blur(12px);
    }

    [data-theme="dark"] {
      /* Dark Theme (Deep Slate) */
      --bg-app: #0f172a;
      --bg-panel: rgba(30, 41, 59, 0.7);
      --fg: #f1f5f9;
      --fg-muted: #94a3b8;
      --border: rgba(51, 65, 85, 0.8);
      
      --primary: #818cf8;
      --primary-hover: #6366f1;
      --primary-fg: #ffffff;
      
      --msg-user-bg: #818cf8;
      --msg-user-fg: #ffffff;
      --msg-ai-bg: #1e293b;
      --msg-ai-fg: #e2e8f0;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-app);
      color: var(--fg);
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: background-color 0.3s ease;
    }

    /* Header */
    header {
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 1.5rem;
      background: var(--bg-panel);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border-bottom: 1px solid var(--border);
      z-index: 50;
    }

    .brand {
      font-family: 'Outfit', sans-serif;
      font-weight: 700;
      font-size: 1.25rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--fg);
    }

    .controls {
      display: flex;
      gap: 1rem;
      align-items: center;
    }

    select {
      padding: 0.4rem 2rem 0.4rem 0.8rem;
      border-radius: 8px;
      border: 1px solid var(--border);
      background-color: var(--bg-panel);
      color: var(--fg);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%2364748b%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 0.7rem top 50%;
      background-size: 0.65rem auto;
    }
    select:focus { outline: 2px solid var(--primary); border-color: transparent; }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--fg-muted);
      cursor: pointer;
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s, color 0.2s;
    }
    .btn-icon:hover { background: var(--border); color: var(--fg); }

    /* Chat Area */
    .chat-container {
      flex: 1;
      overflow-y: auto;
      padding: 2rem 1rem;
      scroll-behavior: smooth;
    }

    .chat-content {
      max-width: 800px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .msg {
      display: flex;
      gap: 1rem;
      opacity: 0;
      animation: fadeIn 0.3s forwards;
    }
    @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } from { opacity: 0; transform: translateY(10px); } }

    .msg.user { flex-direction: row-reverse; }

    .avatar {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      font-size: 1.2rem;
    }
    .msg.ai .avatar { background: var(--bg-panel); border: 1px solid var(--border); color: var(--primary); }
    .msg.user .avatar { background: var(--primary); color: var(--primary-fg); }

    .msg-bubble {
      max-width: 80%;
      padding: 0.75rem 1.25rem;
      border-radius: 16px;
      font-size: 0.95rem;
      line-height: 1.6;
      box-shadow: var(--shadow-sm);
      position: relative;
    }
    
    .msg.ai .msg-bubble {
      background: var(--msg-ai-bg);
      color: var(--msg-ai-fg);
      border: 1px solid var(--border);
      border-top-left-radius: 4px;
    }
    
    .msg.user .msg-bubble {
      background: var(--msg-user-bg);
      color: var(--msg-user-fg);
      border-top-right-radius: 4px;
    }

    /* Markdown Styles */
    .msg-bubble pre {
      background: #282c34;
      border-radius: 8px;
      padding: 1rem;
      overflow-x: auto;
      margin: 0.5rem 0;
    }
    .msg-bubble code {
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.85em;
    }
    .msg-bubble p { margin: 0 0 0.5rem 0; }
    .msg-bubble p:last-child { margin: 0; }
    .msg-bubble a { color: inherit; text-decoration: underline; }

    /* Input Area */
    .input-wrapper {
      padding: 1.5rem;
      background: transparent;
      position: relative;
      z-index: 20;
    }

    .input-box {
      max-width: 800px;
      margin: 0 auto;
      background: var(--bg-panel);
      backdrop-filter: var(--glass-blur);
      -webkit-backdrop-filter: var(--glass-blur);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 0.75rem;
      display: flex;
      align-items: flex-end;
      gap: 0.75rem;
      box-shadow: var(--shadow-md);
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-box:focus-within {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }

    textarea {
      flex: 1;
      background: transparent;
      border: none;
      color: var(--fg);
      font-family: inherit;
      font-size: 0.95rem;
      resize: none;
      padding: 0.5rem 0;
      max-height: 200px;
      min-height: 24px;
      outline: none;
    }
    textarea::placeholder { color: var(--fg-muted); }

    .btn-send {
      background: var(--primary);
      color: var(--primary-fg);
      border: none;
      border-radius: 10px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }
    .btn-send:hover { background: var(--primary-hover); }
    .btn-send:active { transform: scale(0.95); }
    .btn-send:disabled { background: var(--fg-muted); cursor: not-allowed; opacity: 0.5; }

    /* File Preview */
    .file-preview {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--bg-app);
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.85rem;
      border: 1px solid var(--border);
      margin-bottom: 0.5rem;
      width: fit-content;
    }
    .file-preview button {
      background: none; border: none; color: var(--fg-muted);
      cursor: pointer; padding: 0; display: flex;
    }
    .file-preview button:hover { color: #ef4444; }

  </style>
</head>
<body>

  <header>
    <div class="brand">
      <span class="material-icons" style="color: var(--primary);">smart_toy</span>
      OllamaDesk
    </div>
    <div class="controls">
      <select id="modelSelect" title="Modell w√§hlen"></select>
      <button class="btn-icon" id="themeToggle" title="Theme wechseln">
        <span class="material-icons">dark_mode</span>
      </button>
    </div>
  </header>

  <div class="chat-container" id="chatContainer">
    <div class="chat-content" id="chat">
      <!-- Welcome Message -->
      <div class="msg ai">
        <div class="avatar"><span class="material-icons">smart_toy</span></div>
        <div class="msg-bubble">
          Hallo! Ich bin dein lokaler KI-Assistent. W√§hle ein Modell und leg los! üöÄ
        </div>
      </div>
    </div>
  </div>

  <div class="input-wrapper">
    <!-- File Preview Container (Dynamic) -->
    <div id="filePreviewArea" style="max-width: 800px; margin: 0 auto;"></div>

    <div class="input-box">
      <label for="fileInput" class="btn-icon" style="cursor: pointer;" title="Datei anh√§ngen">
        <span class="material-icons">attach_file</span>
      </label>
      <input type="file" id="fileInput" accept=".pdf,.txt,.docx" style="display:none;">
      
      <textarea id="input" placeholder="Schreib eine Nachricht..." rows="1"></textarea>
      
      <button id="sendBtn" class="btn-send" title="Senden">
        <span class="material-icons">arrow_upward</span>
      </button>
    </div>
  </div>

  <script>
    // --- Config ---
    marked.setOptions({
      highlight: function(code, lang) {
        const language = highlight.getLanguage(lang) ? lang : 'plaintext';
        return highlight.highlight(code, { language }).value;
      },
      langPrefix: 'hljs language-'
    });

    // --- Theme ---
    const root = document.documentElement;
    const themeToggle = document.getElementById('themeToggle');
    const themeIcon = themeToggle.querySelector('span');

    function applyTheme(t) {
      root.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      themeIcon.textContent = t === 'dark' ? 'light_mode' : 'dark_mode';
    }

    const savedTheme = localStorage.getItem('theme') || (matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    applyTheme(savedTheme);

    themeToggle.addEventListener('click', () => {
      const current = root.getAttribute('data-theme');
      applyTheme(current === 'dark' ? 'light' : 'dark');
    });

    // --- Auto-Resize Textarea ---
    const textarea = document.getElementById('input');
    textarea.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });

    // --- Chat Logic ---
    let uploadedFile = null;
    let chatHistory = [];
    const chat = document.getElementById("chat");
    const chatContainer = document.getElementById("chatContainer");

    // File Handling
    const fileInput = document.getElementById("fileInput");
    const filePreviewArea = document.getElementById("filePreviewArea");

    fileInput.addEventListener("change", (e) => {
      const file = e.target.files[0];
      if (!file) return;
      uploadedFile = file;
      renderFilePreview();
    });

    function renderFilePreview() {
      filePreviewArea.innerHTML = '';
      if (!uploadedFile) return;

      const div = document.createElement('div');
      div.className = 'file-preview';
      div.innerHTML = `
        <span class="material-icons" style="font-size: 18px;">description</span>
        <span>${uploadedFile.name}</span>
        <button onclick="removeFile()"><span class="material-icons">close</span></button>
      `;
      filePreviewArea.appendChild(div);
    }

    window.removeFile = function() {
      uploadedFile = null;
      fileInput.value = '';
      renderFilePreview();
    };

    // Models
    async function loadModels() {
      try {
        const res = await fetch("http://127.0.0.1:5000/api/models");
        const data = await res.json();
        const select = document.getElementById("modelSelect");
        select.innerHTML = "";
        (data.models || []).forEach(model => {
          const opt = document.createElement("option");
          opt.value = model;
          opt.textContent = model;
          select.appendChild(opt);
        });
      } catch {
        console.error("Server nicht erreichbar");
      }
    }
    loadModels();

    // Send Message
    async function send() {
      const model = document.getElementById("modelSelect").value;
      const msg = textarea.value.trim();
      
      if (!msg && !uploadedFile) return;

      // User Message
      if (msg) {
        appendMessage('user', msg);
      }
      
      // Reset Input
      textarea.value = "";
      textarea.style.height = 'auto';
      
      // AI Placeholder
      const uniqueId = "ai_" + Date.now();
      const aiContentDiv = appendMessage('ai', '<span class="blink">...</span>', uniqueId);

      // Prepare Request
      chatHistory.push({ role: "user", content: msg });
      
      try {
        let res;
        if (uploadedFile) {
          const formData = new FormData();
          formData.append("model", model);
          formData.append("prompt", msg);
          formData.append("file", uploadedFile);
          formData.append("history", JSON.stringify(chatHistory));
          res = await fetch("http://127.0.0.1:5000/api/chat-file", { method: "POST", body: formData });
          removeFile(); // Clear file after send
        } else {
          res = await fetch("http://127.0.0.1:5000/api/chat", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ model, history: chatHistory })
          });
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder("utf-8");
        let fullText = "";

        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          fullText += chunk;
          aiContentDiv.innerHTML = marked.parse(fullText);
          hljs.highlightAll(); // Re-highlight code blocks
          scrollToBottom();
        }
        
        chatHistory.push({ role: "assistant", content: fullText });

      } catch (e) {
        aiContentDiv.textContent = "‚ö†Ô∏è Fehler: " + e.message;
      }
    }

    function appendMessage(role, html, id = null) {
      const div = document.createElement('div');
      div.className = `msg ${role}`;
      div.innerHTML = `
        <div class="avatar">
          <span class="material-icons">${role === 'user' ? 'person' : 'smart_toy'}</span>
        </div>
        <div class="msg-bubble" ${id ? `id="${id}"` : ''}>${html}</div>
      `;
      chat.appendChild(div);
      scrollToBottom();
      return div.querySelector('.msg-bubble');
    }

    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    document.getElementById("sendBtn").addEventListener("click", send);
    textarea.addEventListener("keydown", e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        send();
      }
    });

  </script>
</body>
</html>
